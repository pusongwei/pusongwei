<!DOCTYPE html>
<html lang="ch">
<head>
    <meta charset="UTF-8">
    <title>map</title>
    <meta content="width=device-width,initial-scale=1.0,maxinmum-scale=1.0,user-scalable=0" name="viewport">
    <link rel="stylesheet" type="text/css" href="https://vjmap.com/demo/js/vjmap/vjmap.min.css">
    <script type="text/javascript" src="https://vjmap.com/demo/js/vjmap/vjmap.min.js"></script>
    
    <!-- <script src="https://libs.baidu.com/jquery/2.0.0/jquery.min.js"></script> -->
    <!-- <script src="https://cdn.jsdelivr.net/npm/ol@v7.4.0/dist/ol.js"></script> -->
    <!-- <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/ol@v7.4.0/ol.css"> -->
    <style>
        * {
            margin: 0;
            padding: 0;
        }
        html,body {
            width: 100%;
            height: 100%;
        }
        #map {
            width: 100%;
            height: 100%;
            margin-top: 0;
        }
        .cursor {
            cursor: pointer;
        }
        .vjmapgis-ctrl-top-right .vjmapgis-ctrl {
            margin-top: 50px
        }
    </style>
</head>
<body>
<div id="map"></div>
</body>
<!-- <script type="text/javascript" src="https://unpkg.com/@dcloudio/uni-webview-js@0.0.3/index.js"></script> -->
<script>
    !function(e,n){"object"==typeof exports&&"undefined"!=typeof module?module.exports=n():"function"==typeof define&&define.amd?define(n):(e=e||self).uni=n()}(this,(function(){"use strict";try{var e={};Object.defineProperty(e,"passive",{get:function(){!0}}),window.addEventListener("test-passive",null,e)}catch(e){}var n=Object.prototype.hasOwnProperty;function i(e,i){return n.call(e,i)}var t=[];function r(){return window.__dcloud_weex_postMessage||window.__dcloud_weex_}var o=function(e,n){var i={options:{timestamp:+new Date},name:e,arg:n};if(r()){if("postMessage"===e){var o={data:[n]};return window.__dcloud_weex_postMessage?window.__dcloud_weex_postMessage(o):window.__dcloud_weex_.postMessage(JSON.stringify(o))}var a={type:"WEB_INVOKE_APPSERVICE",args:{data:i,webviewIds:t}};window.__dcloud_weex_postMessage?window.__dcloud_weex_postMessageToService(a):window.__dcloud_weex_.postMessageToService(JSON.stringify(a))}if(!window.plus)return window.parent.postMessage({type:"WEB_INVOKE_APPSERVICE",data:i,pageId:""},"*");if(0===t.length){var d=plus.webview.currentWebview();if(!d)throw new Error("plus.webview.currentWebview() is undefined");var s=d.parent(),w="";w=s?s.id:d.id,t.push(w)}if(plus.webview.getWebviewById("__uniapp__service"))plus.webview.postMessageToUniNView({type:"WEB_INVOKE_APPSERVICE",args:{data:i,webviewIds:t}},"__uniapp__service");else{var u=JSON.stringify(i);plus.webview.getLaunchWebview().evalJS('UniPlusBridge.subscribeHandler("'.concat("WEB_INVOKE_APPSERVICE",'",').concat(u,",").concat(JSON.stringify(t),");"))}},a={navigateTo:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},n=e.url;o("navigateTo",{url:encodeURI(n)})},navigateBack:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},n=e.delta;o("navigateBack",{delta:parseInt(n)||1})},switchTab:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},n=e.url;o("switchTab",{url:encodeURI(n)})},reLaunch:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},n=e.url;o("reLaunch",{url:encodeURI(n)})},redirectTo:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},n=e.url;o("redirectTo",{url:encodeURI(n)})},getEnv:function(e){r()?e({nvue:!0}):window.plus?e({plus:!0}):e({h5:!0})},postMessage:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};o("postMessage",e.data||{})}},d=/uni-app/i.test(navigator.userAgent),s=/Html5Plus/i.test(navigator.userAgent),w=/complete|loaded|interactive/;var u=window.my&&navigator.userAgent.indexOf(["t","n","e","i","l","C","y","a","p","i","l","A"].reverse().join(""))>-1;var g=window.swan&&window.swan.webView&&/swan/i.test(navigator.userAgent);var v=window.qq&&window.qq.miniProgram&&/QQ/i.test(navigator.userAgent)&&/miniProgram/i.test(navigator.userAgent);var c=window.tt&&window.tt.miniProgram&&/toutiaomicroapp/i.test(navigator.userAgent);var m=window.wx&&window.wx.miniProgram&&/micromessenger/i.test(navigator.userAgent)&&/miniProgram/i.test(navigator.userAgent);var p=window.qa&&/quickapp/i.test(navigator.userAgent);var f=window.ks&&window.ks.miniProgram&&/micromessenger/i.test(navigator.userAgent)&&/miniProgram/i.test(navigator.userAgent);var l=window.tt&&window.tt.miniProgram&&/Lark|Feishu/i.test(navigator.userAgent);var _=window.jd&&window.jd.miniProgram&&/micromessenger/i.test(navigator.userAgent)&&/miniProgram/i.test(navigator.userAgent);var E=window.xhs&&window.xhs.miniProgram&&/xhsminiapp/i.test(navigator.userAgent);for(var h,P=function(){window.UniAppJSBridge=!0,document.dispatchEvent(new CustomEvent("UniAppJSBridgeReady",{bubbles:!0,cancelable:!0}))},b=[function(e){if(d||s)return window.__dcloud_weex_postMessage||window.__dcloud_weex_?document.addEventListener("DOMContentLoaded",e):window.plus&&w.test(document.readyState)?setTimeout(e,0):document.addEventListener("plusready",e),a},function(e){if(m)return window.WeixinJSBridge&&window.WeixinJSBridge.invoke?setTimeout(e,0):document.addEventListener("WeixinJSBridgeReady",e),window.wx.miniProgram},function(e){if(v)return window.QQJSBridge&&window.QQJSBridge.invoke?setTimeout(e,0):document.addEventListener("QQJSBridgeReady",e),window.qq.miniProgram},function(e){if(u){document.addEventListener("DOMContentLoaded",e);var n=window.my;return{navigateTo:n.navigateTo,navigateBack:n.navigateBack,switchTab:n.switchTab,reLaunch:n.reLaunch,redirectTo:n.redirectTo,postMessage:n.postMessage,getEnv:n.getEnv}}},function(e){if(g)return document.addEventListener("DOMContentLoaded",e),window.swan.webView},function(e){if(c)return document.addEventListener("DOMContentLoaded",e),window.tt.miniProgram},function(e){if(p){window.QaJSBridge&&window.QaJSBridge.invoke?setTimeout(e,0):document.addEventListener("QaJSBridgeReady",e);var n=window.qa;return{navigateTo:n.navigateTo,navigateBack:n.navigateBack,switchTab:n.switchTab,reLaunch:n.reLaunch,redirectTo:n.redirectTo,postMessage:n.postMessage,getEnv:n.getEnv}}},function(e){if(f)return window.WeixinJSBridge&&window.WeixinJSBridge.invoke?setTimeout(e,0):document.addEventListener("WeixinJSBridgeReady",e),window.ks.miniProgram},function(e){if(l)return document.addEventListener("DOMContentLoaded",e),window.tt.miniProgram},function(e){if(_)return window.JDJSBridgeReady&&window.JDJSBridgeReady.invoke?setTimeout(e,0):document.addEventListener("JDJSBridgeReady",e),window.jd.miniProgram},function(e){if(E)return window.xhs.miniProgram},function(e){return document.addEventListener("DOMContentLoaded",e),a}],y=0;y<b.length&&!(h=b[y](P));y++);h||(h={});var B="undefined"!=typeof uni?uni:{};if(!B.navigateTo)for(var S in h)i(h,S)&&(B[S]=h[S]);return B.webView=h,B}));
</script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/proj4js/2.9.1/proj4-src.min.js"></script>
<script>
    var fromProjection = "+proj=tmerc +lat_0=0 +lon_0=112.5 +k=1 +x_0=500000 +y_0=0 +ellps=krass +towgs84=12.1575,-159.86,-82.3,0,0,0,0 +units=m +no_defs" ;
    var toProjection ="+proj=longlat +ellps=WGS84 +datum=WGS84 +no_defs";
    // proj4(fromProjection,toProjection,[491278.162,3938380.151,648]);//[y,x,z]
    var first = 1
    var mapId = "cd209a1f2356";
    var serviceUrl = "https://vjmap.com/server/api/v1";
    var accessToken = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJJRCI6MiwiVXNlcm5hbWUiOiJhZG1pbjEiLCJOaWNrTmFtZSI6ImFkbWluMSIsIkF1dGhvcml0eUlkIjoiYWRtaW4iLCJCdWZmZXJUaW1lIjo4NjQwMCwiZXhwIjo0ODEzMjY3NjM3LCJpc3MiOiJ2am1hcCIsIm5iZiI6MTY1OTY2NjYzN30.cDXCH2ElTzU2sQU36SNHWoTYTAc4wEkVIXmBAIzWh6M"
    // CAD图key
    var accessKey = "akd31dd88bc7e5c603"

    var map = ""
    var center = [112.40427073819657, 35.574472506700104]
    var routeLine = ""
    var markers = []
    var peopleMarker = ""
    var clickMarker = ""
    var setCen = true
    var anim = null
    var realRoute = null
    var lineList = []
    var markersPosList = []
    // 添加点标记
    function setMarkerList (str) {
        // str = `[{"id":67,"updateTime":"2023-06-08 17:56:33","profileId":1,"checkTime":"2023-06-08 17:55:33","files":"","pos":"110.86939688130872,35.54867201186224","realName":"系统管理员"},{"id":68,"updateTime":"2023-06-08 17:56:40","profileId":1,"checkTime":"2023-06-08 17:55:33","files":"","pos":"110.86969368474274,35.54858283586117","realName":"系统管理员"},{"id":69,"updateTime":"2023-06-08 17:56:50","profileId":1,"checkTime":"2023-06-08 17:55:33","files":"","pos":"110.86937356272364,35.54842796391607","realName":"系统管理员"},{"id":70,"updateTime":"2023-06-08 17:56:58","profileId":1,"checkTime":"2023-06-08 17:55:33","files":"","pos":"110.86886118906398,35.54855818071097","realName":"系统管理员"},{"id":71,"updateTime":"2023-06-08 17:57:06","profileId":1,"checkTime":"2023-06-08 17:55:33","files":"","pos":"110.86844907087044,35.548506677274645","realName":"系统管理员"},{"id":72,"updateTime":"2023-06-08 17:57:14","profileId":1,"checkTime":"2023-06-08 17:55:33","files":"","pos":"110.86825959129743,35.548700049751275","realName":"系统管理员"}]`
        markersPosList = JSON.parse(str)
        markersPosList.map((item, i) => {
            const pos = {
                lng: item.pos.split(",")[0],
                lat: item.pos.split(",")[1]
            }
            let _marker = new vjmap.DiffusedApertureMarker({
                lngLat: pos
            }, {
                colors: ["red", "rgba(,0,0,0,0)"],
                textColor: "#000"
            }).createMarker();
            _marker.addTo(map)
            markers.push(_marker)
            _marker.on("click", (e) => {
                uni.postMessage({  
                    data: {  
                        action: {
                            type: 2,
                            data: item
                        }
                    }  
                });
                window.parent.postMessage({
                    params: {
                        type: 2,
                        data: item
                    }
                },'*');
            })
        })
    }
    // 删除点标记
    function removeMarker () {
        markers.map((item,i) => {
            item && item.remove()
        })
    }
    // 添加点击标记 如果已经有点击标记 则点击标记移动位置
    function setClickMarker (center) {
        
        if (typeof center == "string") {
            center = center.split(",")
        }
        if (!clickMarker) {
            clickMarker = new vjmap.Marker({color: "red"})
            clickMarker.setLngLat(center).addTo(map)
        } else {
            clickMarker.setLngLat(center)
        }
    }
    // 删除点击标记
    function clearClickMarker() {
        clickMarker.remove()
        clickMarker = null
    }
    // 显示当前人定位marker
    function showPeopleMarker () {
        if (!peopleMarker) {
            peopleMarker = new vjmap.Marker()
        }
        peopleMarker.setLngLat(center).addTo(map)
    }
    // 设置地图中心
    function setCenter(str, type) {
        center = str.split(",")
        map.setCenter(center)
        if (!type) {
            peopleMarker.setLngLat(center)
        }
    }
    // 设置当前人位置
    function setPeopleMarker(str) {
        center = str.split(",")
        if (!peopleMarker) {
            peopleMarker = new vjmap.Marker()
            peopleMarker.setLngLat(center).addTo(map)
        } else {
            peopleMarker.setLngLat(center)
        }
    }
    // 设置路径线
    function setLine(str, color) {
        // 路径线
        var routePath = JSON.parse(str)
        if (!routeLine) {
            routeLine = new vjmap.PolylineArrow({
                path: map.toLngLat(routePath),
                lineWidth: 10,
                showDir: true,
                lineColor: color
            })
            routeLine.addTo(map);
        } else {
            routeLine.setPath(map.toLngLat(routePath))
        }
    }
    // 设置地图显示范围
    function setMapRadius (str, padding) {
        const obj = vjmap.GeoBounds.fromDataExtent(str)
        padding = padding ? JSON.parse(padding) : 50
        // obj.max = proj4(toProjection,fromProjection,obj.max)
        // obj.min = proj4(toProjection,fromProjection,obj.min)
        map.fitMapBounds(obj, {
            padding: padding
        });
    }
    // 设置导航路径线
    var daohangLine = ""
    function setdaohangLine(str, color) {
        // 路径线
        var routePath = JSON.parse(str)
        if (!daohangLine) {
            daohangLine = new vjmap.PolylineArrow({
                path: map.toLngLat(routePath),
                lineWidth: 10,
                showDir: true,
                lineColor: color
            })
            daohangLine.addTo(map);
        } else {
            daohangLine.setPath(map.toLngLat(routePath))
        }
    }
    // 恢复当前地图中心及缩放大小
    function mapResize() {
        map.easeTo({
            zoom: 16,
            center: center,
            bearing: 0,
            pitch: 0
        })
        setTimeout(() => {
            setCen = true
        }, 1000)
    }
    // uniapp加载地图
    function mapConfig (str) {
        const obj = JSON.parse(str)
        mapId = obj.mapId;
        accessToken = obj.accessToken;
        serviceUrl = obj.serviceUrl;
        // CAD图key
        accessKey = obj.accessKey
        loadMap(obj.arr, obj.isRoadway)
        // loadOpenLayersMap()
    }
    loadMap()

    // 接受VUE页面发来的信息
    // window.addEventListener("message", function (event) {
    //     var params = event.data.params;
    //     // 定义一个变量去接收,然后就可以获得vue传过来的数据
    //     if (params) {
    //         var data = params["data"]
    //         if(params["type"] == 1) {
    //             if (data) {
    //                 mapId = data.mapId;
    //                 accessToken = data.accessToken;
    //                 serviceUrl = data.serviceUrl;
    //                 // CAD图key
    //                 accessKey = data.accessKey
    //                 loadMap(data.arr, data.isRoadway)
    //             } else {
    //                 loadMap()
    //             }
    //             // loadOpenLayersMap()
    //         }
    //         if (params["type"] == 2) {
    //             trackPlayback(data, 2)
    //         }
    //         if (params["type"] == 3) {
    //             trackPlayback(data, 3)
    //         }
    //         if (params["type"] == 4) {
    //             trackPlayback(data, 4)
    //         }
    //         if (params["type"] == 5) {
    //             clearClickMarker()
    //         }
    //     }
    // }, '*')
    // 轨迹回放
    function trackPlayback (data, type) {
        if (type == 2) {
            setLines(JSON.stringify(data))
        }
        if (type == 3) {
            removeMarker()
            setMarkerList(data)
        }
        if (type == 4) {
            fitBounds(data)
        }
        
        // if (anim) {
        //     anim.stop()
        // }
        // // 实时动画轨迹线
        // realRoute = new vjmap.PolylineArrow({
        //     path: map.toLngLat(routePath),
        //     lineWidth: 10,
        //     showDir: true,
        //     showBorder: true,
        //     borderColor: "#f00",
        //     lineColor: '#FF9900'
        // });
        // realRoute.addTo(map);
        // // 线动画
        // anim = realRoute.animate(100, 10, true, status => console.log(status), (status, context) => {
        //     // 动画每帧回调，在这里可以实时改变车的位置
        //     // 获取角度
        //     const angle = vjmap.geoPoint(context.endPnt).angleTo(vjmap.geoPoint(context.startPnt));
        //     // 生成新的数据
        //     const carGeoJson = vjmap.createPointGeoJson({
        //         point: context.endPnt,
        //         properties: { bearing: vjmap.radToDeg(-angle)}
        //     });
        //     const last = routePath[routePath.length - 1]
        //     // 判断点是否相等 
        //     if (vjmap.geoPoint(last).equals(vjmap.geoPoint(context.endPnt))) {
        //         anim.stop()
        //     }
        //     // 更新车的数据
        //     peopleMarker.setLngLat(context.endPnt); // 更新位置
        //     map.setCenter(context.endPnt)
        // })
    }
    // 设置多条路径线
    var routeLineList = []
    function setLines(str) {
        console.log("开始设置路线")
        if (routeLineList.length) {
            routeLineList.map((item) => {
                item.remove()
            })
        }
        routeLineList = []
        // 路径线
        var list = JSON.parse(str)
        for(let i = 0; i < list.length; i++) {
            var routePath = list[i].path
            if (routePath.length) {
                routeLine = new vjmap.PolylineArrow({
                    path: map.toLngLat(routePath),
                    lineWidth: 10,
                    showDir: true,
                    lineColor: list[i].color
                })
                routeLine.addTo(map);
                routeLineList.push(routeLine)
            }
        }
        
    }

    // 平移和缩放地图以将其可见区域包含在指定的地理边界内
    function fitBounds(arr) {
        map.fitBounds(arr, {
            padding: {top: 30, bottom:30, left: 30, right: 30}
        })
    }
    


    document.addEventListener('UniAppJSBridgeReady', function() {
        uni.webView.getEnv(function(res) {
            console.log('当前环境：' + JSON.stringify(res));
        });
        // H5页面加载完毕
        uni.postMessage({  
            data: {  
                action: {
                    type: 1
                }
            }  
        });
        // 向父vue页面发送信息
        window.parent.postMessage({
            params: {
                type: 1
            }
        },'*');
    });
    function loadMap(arr, isRoadway) {
        (async () => {
            // --高德地图与CAD图叠加[高德地图为底图]--高德地图与CAD图叠加，以高德地图为坐标系
            svc = new vjmap.Service(serviceUrl, accessToken)
            svc.addAccessKey(accessKey)
            // 根据地图范围建立经纬度投影坐标系
            let prj = new vjmap.LnglatProjection();
            let tileUrl = ""
            if (isRoadway == 1) {
                tileUrl = ["https://webrd01.is.autonavi.com/appmaptile?lang=zh_cn&size=1&scale=1&style=8&x={x}&y={y}&z={z}"]
            } else {
                tileUrl = ["https://webst01.is.autonavi.com/appmaptile?lang=zh_cn&size=1&scale=1&style=6&x={x}&y={y}&z={z}",
                        "https://webst02.is.autonavi.com/appmaptile?lang=zh_cn&size=1&scale=1&style=6&x={x}&y={y}&z={z}",
                        "https://webst03.is.autonavi.com/appmaptile?lang=zh_cn&size=1&scale=1&style=6&x={x}&y={y}&z={z}",
                        "https://webst04.is.autonavi.com/appmaptile?lang=zh_cn&size=1&scale=1&style=6&x={x}&y={y}&z={z}"]
            }
            console.log(tileUrl)
            // 地图对象
            map = new vjmap.Map({
                container: 'map', // DIV容器ID
                style: {
                    // version: 8,
                    version: svc.styleVersion(),
                    glyphs: svc.glyphsUrl(),
                    sources: {
                        gaode: {
                            type: 'raster',
                            tiles:  tileUrl,
                        }
                    },
                    layers: [{
                        id: 'gaode',
                        type: 'raster',
                        source: 'gaode',
                    }]
                },
                center: center,
                zoom: 16,
                pitch: 0,
                maxZoom: 18,
                optimizeForTerrain : true,
                pitchWithRotate: false, // 倾斜
                dragRotate: false, // 拖动旋转
                touchZoomRotate: true, // 捏合旋转和缩放
                doubleClickZoom: false, // 双击缩放
                renderWorldCopies: false // 不显示多屏地图
            });
            
            
            
            // 关联服务对象和投影对象
            map.attach(svc, prj);
            await map.onLoad();


            // 先打开cad图
            let res = await svc.openMap({
                mapid: mapId, // 地图ID
                mapopenway: vjmap.MapOpenWay.GeomRender, // 以几何数据渲染方式打开
                style: svc.vectorStyle()
            })
            if (res.error) {
                // 如果打开出错
                message.error(res.error)
            }
            let layer
            // arr = ["0","图例","三线","积水区","周边矿井","采区划分","保安煤柱"]
            if (arr) {
                let res1 = await svc.cmdSwitchLayers(arr); // 调用唯杰服务切换图层，返回图层id {layerid： "xxxx"}
                layer = res1.layerid
            } else {
                layer = res.layer;//图层样式名
            }
            
            // 增加cad的wms图层
            let wmsUrl = svc.wmsTileUrl({
                mapid: mapId, // 地图id
                layers: layer, // 图层名称
                srs: "EPSG:3857",
                crs: fromProjection,
                webMapType: "GCJ02" // 底图是高德地图，所以要选GCJ02,如果是天地图，可以不用填此项
            })
            
           
            map.addSource('wms-test-source', {
                'type': 'raster',
                'tiles': [
                    wmsUrl
                ],
                'tileSize': 256
            });
            map.addLayer({
                    'id': 'wms-test-layer',
                    'type': 'raster',
                    'source': 'wms-test-source',
                    'paint': { "raster-opacity": 1 }
                }
            );
            // 比例尺
            const scaleControl = new vjmap.ScaleControl();
            map.addControl(scaleControl, "bottom-left");
            // 导航条
            const navigationControl = new vjmap.NavigationControl();
            map.addControl(navigationControl, "top-right");
            // 地图加载完毕
            uni.postMessage({  
                data: {  
                    action: {
                        type: 1.1
                    }
                }  
            });
            // 向父vue页面发送信息
            window.parent.postMessage({
                params: {
                    type: 1.1
                }
            },'*');

            let type1 = 1
            map.on("click", (event) => {
                // setCenter("116.207672,39.994943")
                // if (type1 == 1) {
                //     type1 = 2
                // } else {
                //     type1 = 1
                // }
                // setDitu(type1)
                let point = map.fromLngLat(event.lngLat);
                var transformPoint = proj4(toProjection,fromProjection,point);//[y,x,z]
                console.log(event)
                // 向父vue页面发送信息
                // window.parent.postMessage({
                //     params: {
                //         type: 3,
                //         data: [point.x, point.y]
                //     }
                // },'*');
                var new_york = new vjmap.LngLat(point.x, point.y);
                var yuan = true
                markersPosList.map((item) => {
                    var pos = item.pos.split(",")
                    var los_angeles = new vjmap.LngLat(pos[0], pos[1]);
                    var juli = new_york.distanceTo(los_angeles);
                    if (juli < 10) {
                        yuan = false
                    }
                })

                var elevation = map.Elevation
                console.log(getAtPoint.getAtPoint([point.x, point.y]))
                
                // const str = `[[112.439027,35.45133],["112.43888","35.451419"],["112.438746","35.451272"],["112.438698","35.45125"],["112.438646","35.451241"],["112.438572","35.451241"],["112.438572","35.451241"],["112.438433","35.451285"],["112.438342","35.451332"],["112.437218","35.452018"],["112.437023","35.452166"],["112.436905","35.45227"],["112.436745","35.452431"],["112.436419","35.452865"],["112.436302","35.452964"],["112.436302","35.452964"],["112.436272","35.452995"],["112.436137","35.453103"],["112.435556","35.453481"],["112.435373","35.453563"],["112.4352","35.453628"],["112.434978","35.453672"],["112.434748","35.45372"],["112.434635","35.453759"],["112.434284","35.453906"],["112.433733","35.454149"],["112.433511","35.45424"],["112.43339","35.45428"],["112.433168","35.454319"],["112.432878","35.454345"],["112.432431","35.454392"],["112.432431","35.454392"],["112.431697","35.454475"],["112.431693","35.454475"],["112.431306","35.454431"],["112.431302","35.454427"],["112.430872","35.453689"],["112.430751","35.453455"],["112.430734","35.453411"],["112.430734","35.453381"],["112.43072","35.45332"],["112.43072","35.45332"],["112.430712","35.453203"],["112.430710","35.453201"]]`
                // setMapRadius(str, '{"left":50,"right":50,"top":250,"bottom":200}')
                // setdaohangLine(str, '#009EFF')
                if (yuan) {
                    uni.postMessage({  
                        data: {  
                            action: {
                                type: 3,
                                data: [[point.x, point.y],[transformPoint.x, transformPoint.y]]
                            }
                        }  
                    });
                    // 点击位置添加标点
                    // setClickMarker([point.x, point.y])
                    // setCenter([point.x, point.y].toString(), 1)
                    // setTimeout(() => {
                    //     let layers = svc.getMapLayers();
                    //     let brr = []
                    //     layers.map((item) => {
                    //         if (brr.length < 10) {
                    //             brr.push(item.name)
                    //         }
                    //     })
                    //     setTuCeng(brr)
                    // }, 2000)
                }
                // setTuCeng(brr)
            })
            map.on("move", () => {
                setCen = false
            })
            map.on("touchstart", () => {
                uni.postMessage({  
                    data: {  
                        action: {
                            type: 5,
                            data: 1
                        }
                    }  
                });
            })

            let layers = svc.getMapLayers();
            let brr = []
            layers.map((item) => {
                if (!item.isOff) {
                    brr.push(item.name)
                }
            })
            console.log(layers)
            // console.log(brr)
            // setTuCeng(brr)
            uni.postMessage({  
                data: {  
                    action: {
                        type: 4,
                        data: layers
                    }
                }  
            });

            
        })();
    }
    function setTuCeng (arr) {
        console.log(arr)
        console.log(typeof arr)
        if (typeof arr === "string") {
            arr = JSON.parse(arr)
        }
        (async () => {
            let res1 = await svc.cmdSwitchLayers(arr); // 调用唯杰服务切换图层，返回图层id {layerid： "xxxx"}
            map.removeLayer("wms-test-layer")
            map.removeSource('wms-test-source');
            wmsUrl = svc.wmsTileUrl({
                mapid: mapId, // 地图id
                layers: res1.id || res1.layerid, // 图层名称
                srs: "EPSG:3857",
                crs: fromProjection,
                webMapType: "GCJ02" // 底图是高德地图，所以要选GCJ02,如果是天地图，可以不用填此项
            })
            map.addSource('wms-test-source', {
                'type': 'raster',
                'tiles': [
                    wmsUrl
                ],
                'tileSize': 256
            });
            map.addLayer({
                    'id': 'wms-test-layer',
                    'type': 'raster',
                    'source': 'wms-test-source',
                    'paint': { "raster-opacity": 1 }
                }
            );
        })();
    }
    function setDitu (isRoadway) {
        const style = map.getStyle()
        let tileUrl = ""
        if (isRoadway == 1) {
            tileUrl = ["https://webrd01.is.autonavi.com/appmaptile?lang=zh_cn&size=1&scale=1&style=8&x={x}&y={y}&z={z}"]
        } else {
            tileUrl = ["https://webst01.is.autonavi.com/appmaptile?lang=zh_cn&size=1&scale=1&style=6&x={x}&y={y}&z={z}",
                    "https://webst02.is.autonavi.com/appmaptile?lang=zh_cn&size=1&scale=1&style=6&x={x}&y={y}&z={z}",
                    "https://webst03.is.autonavi.com/appmaptile?lang=zh_cn&size=1&scale=1&style=6&x={x}&y={y}&z={z}",
                    "https://webst04.is.autonavi.com/appmaptile?lang=zh_cn&size=1&scale=1&style=6&x={x}&y={y}&z={z}"]
        }
       
        style.sources.gaode.tiles = tileUrl
        map.setStyle(style)
    }
    
    
    
    
    

   

    
</script>
</html>