<!DOCTYPE html>
<html lang="ch">
<head>
    <meta charset="UTF-8">
    <title>map</title>
    <meta content="width=device-width,initial-scale=1.0,maxinmum-scale=1.0,user-scalable=0" name="viewport">
    <link rel="stylesheet" type="text/css" href="https://vjmap.com/demo/js/vjmap/vjmap.min.css">
    <script type="text/javascript" src="https://vjmap.com/demo/js/vjmap/vjmap.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/proj4js/2.9.0/proj4.min.js"></script>
    
    <script src="https://libs.baidu.com/jquery/2.0.0/jquery.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
        }
        #map {
            position: absolute;
            left: 0;
            right: 0;
            top: 0px;
            bottom: 0;
        }
        .cursor {
            cursor: pointer;
        }
    </style>
</head>
<body>
<div id="map"></div>
</body>
<script type="text/javascript" src="https://unpkg.com/@dcloudio/uni-webview-js@0.0.3/index.js"></script>
<script src="https://gitee.com/dcloud/uni-app/raw/dev/dist/uni.webview.1.5.4.js"></script>
<script>
    var mapId = "cd209a1f2356";
    var serviceUrl = "https://vjmap.com/server/api/v1";
    var accessToken = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJJRCI6MiwiVXNlcm5hbWUiOiJhZG1pbjEiLCJOaWNrTmFtZSI6ImFkbWluMSIsIkF1dGhvcml0eUlkIjoiYWRtaW4iLCJCdWZmZXJUaW1lIjo4NjQwMCwiZXhwIjo0ODEzMjY3NjM3LCJpc3MiOiJ2am1hcCIsIm5iZiI6MTY1OTY2NjYzN30.cDXCH2ElTzU2sQU36SNHWoTYTAc4wEkVIXmBAIzWh6M"
    // CAD图key
    var accessKey = "akf65237a99b5e56c2"

    var map = ""
    var center = [110.8680839066069,35.548207938846645]
    var routeLine = ""
    var markers = []
    var peopleMarker = ""
    var clickMarker = ""
    var setCen = true
    var anim = null
    var realRoute = null
    var lineList = []
    // 添加点标记
    function setMarkerList (str) {
        // str = `[{"id":67,"updateTime":"2023-06-08 17:56:33","profileId":1,"checkTime":"2023-06-08 17:55:33","files":"","pos":"110.86939688130872,35.54867201186224","realName":"系统管理员"},{"id":68,"updateTime":"2023-06-08 17:56:40","profileId":1,"checkTime":"2023-06-08 17:55:33","files":"","pos":"110.86969368474274,35.54858283586117","realName":"系统管理员"},{"id":69,"updateTime":"2023-06-08 17:56:50","profileId":1,"checkTime":"2023-06-08 17:55:33","files":"","pos":"110.86937356272364,35.54842796391607","realName":"系统管理员"},{"id":70,"updateTime":"2023-06-08 17:56:58","profileId":1,"checkTime":"2023-06-08 17:55:33","files":"","pos":"110.86886118906398,35.54855818071097","realName":"系统管理员"},{"id":71,"updateTime":"2023-06-08 17:57:06","profileId":1,"checkTime":"2023-06-08 17:55:33","files":"","pos":"110.86844907087044,35.548506677274645","realName":"系统管理员"},{"id":72,"updateTime":"2023-06-08 17:57:14","profileId":1,"checkTime":"2023-06-08 17:55:33","files":"","pos":"110.86825959129743,35.548700049751275","realName":"系统管理员"}]`
        const list = JSON.parse(str)
        list.map((item, i) => {
            const pos = {
                lng: item.pos.split(",")[0],
                lat: item.pos.split(",")[1]
            }
            let _marker = new vjmap.DiffusedApertureMarker({
                lngLat: pos
            }, {
                colors: ["red", "rgba(,0,0,0,0)"],
                textColor: "#000"
            }).createMarker();
            _marker.addTo(map)
            markers.push(_marker)
            _marker.on("click", (e) => {
                uni.postMessage({  
                    data: {  
                        action: {
                            type: 2,
                            data: item
                        }
                    }  
                });
                window.parent.postMessage({
                    params: {
                        type: 2,
                        data: item
                    }
                },'*');
            })
        })
    }
    // 删除点标记
    function removeMarker () {
        markers.map((item,i) => {
            item && item.remove()
        })
    }
    // 显示当前人定位marker
    function showPeopleMarker () {
        peopleMarker = new vjmap.Marker()
        peopleMarker.setLngLat(center).addTo(map)
    }
    // 设置地图中心
    function setCenter(str) {
        center = str.split(",")
        peopleMarker.setLngLat(center)
        if (setCen) {
            map.setCenter(center)
        }
    }
    // 设置路径线
    function setLine(str) {
        // 路径线
        var routePath = JSON.parse(str)
        if (!routeLine) {
            routeLine = new vjmap.PolylineArrow({
                path: map.toLngLat(routePath),
                lineWidth: 10,
                showDir: true,
                lineColor: '#009EFF'
            })
            routeLine.addTo(map);
        } else {
            routeLine.setPath(map.toLngLat(routePath))
        }
    }
    // 恢复当前地图中心及缩放大小
    function mapResize() {
        map.easeTo({
            zoom: 18,
            center: center,
            bearing: 0,
            pitch: 0
        })
        setTimeout(() => {
            setCen = true
        }, 1000)
    }
    // uniapp加载地图
    function mapConfig (str) {
        const obj = JSON.parse(str)
        mapId = obj.mapId;
        accessToken = obj.accessToken;
        serviceUrl = obj.serviceUrl;
        // CAD图key
        accessKey = obj.accessKey
        loadMap()
    }

    // 接受VUE页面发来的信息
    window.addEventListener("message", function (event) {
        var params = event.data.params;
        // 定义一个变量去接收,然后就可以获得vue传过来的数据
        if (params) {
            console.log(params)
            var data = params["data"]
            if(params["type"] == 1) {
                if (data ) {
                    mapId = data.mapId;
                    accessToken = data.accessToken;
                    serviceUrl = data.serviceUrl;
                    // CAD图key
                    accessKey = data.accessKey
                }
               
                loadMap()
            }
            if (params["type"] == 2) {
                trackPlayback(data, 2)
            }
            if (params["type"] == 3) {
                trackPlayback(data, 3)
            }
            if (params["type"] == 4) {
                trackPlayback(data, 4)
            }
        }
    }, '*')
    // 轨迹回放
    function trackPlayback (data, type) {
        if (type == 2) {
            setLines(JSON.stringify(data))
        }
        if (type == 3) {
            removeMarker()
            setMarkerList(data)
        }
        if (type == 4) {
            fitBounds(data)
        }
        
        // if (anim) {
        //     anim.stop()
        // }
        // // 实时动画轨迹线
        // realRoute = new vjmap.PolylineArrow({
        //     path: map.toLngLat(routePath),
        //     lineWidth: 10,
        //     showDir: true,
        //     showBorder: true,
        //     borderColor: "#f00",
        //     lineColor: '#FF9900'
        // });
        // realRoute.addTo(map);
        // // 线动画
        // anim = realRoute.animate(100, 10, true, status => console.log(status), (status, context) => {
        //     // 动画每帧回调，在这里可以实时改变车的位置
        //     // 获取角度
        //     const angle = vjmap.geoPoint(context.endPnt).angleTo(vjmap.geoPoint(context.startPnt));
        //     // 生成新的数据
        //     const carGeoJson = vjmap.createPointGeoJson({
        //         point: context.endPnt,
        //         properties: { bearing: vjmap.radToDeg(-angle)}
        //     });
        //     const last = routePath[routePath.length - 1]
        //     // 判断点是否相等 
        //     if (vjmap.geoPoint(last).equals(vjmap.geoPoint(context.endPnt))) {
        //         anim.stop()
        //     }
        //     // 更新车的数据
        //     peopleMarker.setLngLat(context.endPnt); // 更新位置
        //     map.setCenter(context.endPnt)
        // })
    }
    // 设置多条路径线
    var routeLineList = []
    function setLines(str) {
        console.log("开始设置路线")
        if(peopleMarker) {
            peopleMarker.remove()
        }
        if (routeLineList.length) {
            routeLineList.map((item) => {
                item.remove()
            })
        }
        routeLineList = []
        // 路径线
        var list = JSON.parse(str)
        for(let i = 0; i < list.length; i++) {
            var routePath = list[i].path
            if (routePath.length) {
                routeLine = new vjmap.PolylineArrow({
                    path: map.toLngLat(routePath),
                    lineWidth: 10,
                    showDir: true,
                    lineColor: list[i].color
                })
                routeLine.addTo(map);
                routeLineList.push(routeLine)
            }
        }
        
    }
    // 平移和缩放地图以将其可见区域包含在指定的地理边界内
    function fitBounds(arr) {
        map.fitBounds(arr, {
            padding: {top: 30, bottom:30, left: 30, right: 30}
        })
    }
    


    document.addEventListener('UniAppJSBridgeReady', function() {
        uni.webView.getEnv(function(res) {
            console.log('当前环境：' + JSON.stringify(res));
        });
        // H5页面加载完毕
        uni.postMessage({  
            data: {  
                action: {
                    type: 1
                }
            }  
        });
        // 向父vue页面发送信息
        window.parent.postMessage({
            params: {
                type: 1
            }
        },'*');
    });
    function loadMap() {
        (async () => {
            // --高德地图与CAD图叠加[高德地图为底图]--高德地图与CAD图叠加，以高德地图为坐标系
            let svc = new vjmap.Service(serviceUrl, accessToken)
            svc.addAccessKey(accessKey)
            // 根据地图范围建立经纬度投影坐标系
            let prj = new vjmap.LnglatProjection();
            // 地图对象
            map = new vjmap.Map({
                container: 'map', // DIV容器ID
                style: {
                    version: svc.styleVersion(),
                    glyphs: svc.glyphsUrl(),
                    sources: {
                        gaode: {
                            type: 'raster',
                            tiles: [
                                "https://webrd01.is.autonavi.com/appmaptile?lang=zh_cn&size=1&scale=1&style=8&x={x}&y={y}&z={z}"
                                // 影像地图
                                // "https://webst01.is.autonavi.com/appmaptile?lang=zh_cn&size=1&scale=1&style=6&x={x}&y={y}&z={z}"
                            ],
                        }
                    },
                    layers: [{
                        id: 'gaode',
                        type: 'raster',
                        source: 'gaode',
                    }]
                },
                center: center,
                zoom: 18,
                pitch: 0,
                pitchWithRotate: false, // 倾斜
                dragRotate: false, // 拖动旋转
                touchZoomRotate: true, // 捏合旋转和缩放
                doubleClickZoom: false, // 双击缩放
                renderWorldCopies: false // 不显示多屏地图
            });
            // 关联服务对象和投影对象
            map.attach(svc, prj);
            await map.onLoad();
            // 先打开cad图
            
            let res = await svc.openMap({
                mapid: mapId, // 地图ID
                mapopenway: vjmap.MapOpenWay.GeomRender, // 以几何数据渲染方式打开
                style: vjmap.openMapLightStyle() // div为深色背景颜色时，这里也传深色背景样式
            })
            if (res.error) {
                // 如果打开出错
                message.error(res.error)
            }
            let layer = res.layer;//图层样式名
            
            let cadEpsg = "EPSG:4546";// cad图的espg代号
            // 增加cad的wms图层
            let wmsUrl = svc.wmsTileUrl({
                mapid: mapId, // 地图id
                layers: layer, // 图层名称
                srs: "EPSG:3857",
                crs: cadEpsg,
                
                webMapType: "GCJ02" // 底图是高德地图，所以要选GCJ02,如果是天地图，可以不用填此项
            })
            map.addSource('wms-test-source', {
                'type': 'raster',
                'tiles': [
                    wmsUrl
                ],
                'tileSize': 256
            });
            map.addLayer({
                    'id': 'wms-test-layer',
                    'type': 'raster',
                    'source': 'wms-test-source',
                    'paint': { "raster-opacity": 1 }
                }
            );
            // 比例尺
            const scaleControl = new vjmap.ScaleControl();
            map.addControl(scaleControl, "bottom-left");
            // 导航条
            const navigationControl = new vjmap.NavigationControl();
            map.addControl(navigationControl, "top-right");
            // 地图加载完毕
            uni.postMessage({  
                data: {  
                    action: {
                        type: 1.1
                    }
                }  
            });
            // 向父vue页面发送信息
            window.parent.postMessage({
                params: {
                    type: 1.1
                }
            },'*');

            
            
            map.on("click", (event) => {
                let point = map.fromLngLat(event.lngLat);
                console.log(`[${point.x},${point.y}]`)
                // 向父vue页面发送信息
                window.parent.postMessage({
                    params: {
                        type: 3,
                        data: [point.x, point.y]
                    }
                },'*');
                uni.postMessage({  
                    data: {  
                        action: {
                            type: 3,
                            data: [point.x, point.y]
                        }
                    }  
                });
            })
            map.on("move", () => {
                setCen = false
            })
            
            
            

            
        })();
    }
    
    
    
    

   

    
</script>
</html>