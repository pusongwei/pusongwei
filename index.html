<!DOCTYPE html>
<html lang="ch">
<head>
    <meta charset="UTF-8">
    <title>map</title>
    <meta content="width=device-width,initial-scale=1.0,maxinmum-scale=1.0,user-scalable=0" name="viewport">
    <link rel="stylesheet" type="text/css" href="https://vjmap.com/demo/js/vjmap/vjmap.min.css">
    <script type="text/javascript" src="https://vjmap.com/demo/js/vjmap/vjmap.min.js"></script>
    
    <script src="https://libs.baidu.com/jquery/2.0.0/jquery.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/ol@v7.4.0/dist/ol.js"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/ol@v7.4.0/ol.css">
    <style>
        * {
            margin: 0;
            padding: 0;
        }
        html,body {
            width: 100%;
            height: 100%;
        }
        #map {
            width: 100%;
            height: 100%;
            margin-top: 0;
        }
        .cursor {
            cursor: pointer;
        }
    </style>
</head>
<body>
<div id="map"></div>
</body>
<script type="text/javascript" src="https://unpkg.com/@dcloudio/uni-webview-js@0.0.3/index.js"></script>
<script src="https://gitee.com/dcloud/uni-app/raw/dev/dist/uni.webview.1.5.4.js"></script>
<script>
    var first = 1
    var mapId = "cd209a1f2356";
    var serviceUrl = "https://vjmap.com/server/api/v1";
    var accessToken = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJJRCI6MiwiVXNlcm5hbWUiOiJhZG1pbjEiLCJOaWNrTmFtZSI6ImFkbWluMSIsIkF1dGhvcml0eUlkIjoiYWRtaW4iLCJCdWZmZXJUaW1lIjo4NjQwMCwiZXhwIjo0ODEzMjY3NjM3LCJpc3MiOiJ2am1hcCIsIm5iZiI6MTY1OTY2NjYzN30.cDXCH2ElTzU2sQU36SNHWoTYTAc4wEkVIXmBAIzWh6M"
    // CAD图key
    var accessKey = "akd538cb61c41daa3d"

    var map = ""
    var center = [110.8680839066069,35.548207938846645]
    var routeLine = ""
    var markers = []
    var peopleMarker = ""
    var clickMarker = ""
    var setCen = true
    var anim = null
    var realRoute = null
    var lineList = []
    var markersPosList = []
    // 添加点标记
    function setMarkerList (str) {
        // str = `[{"id":67,"updateTime":"2023-06-08 17:56:33","profileId":1,"checkTime":"2023-06-08 17:55:33","files":"","pos":"110.86939688130872,35.54867201186224","realName":"系统管理员"},{"id":68,"updateTime":"2023-06-08 17:56:40","profileId":1,"checkTime":"2023-06-08 17:55:33","files":"","pos":"110.86969368474274,35.54858283586117","realName":"系统管理员"},{"id":69,"updateTime":"2023-06-08 17:56:50","profileId":1,"checkTime":"2023-06-08 17:55:33","files":"","pos":"110.86937356272364,35.54842796391607","realName":"系统管理员"},{"id":70,"updateTime":"2023-06-08 17:56:58","profileId":1,"checkTime":"2023-06-08 17:55:33","files":"","pos":"110.86886118906398,35.54855818071097","realName":"系统管理员"},{"id":71,"updateTime":"2023-06-08 17:57:06","profileId":1,"checkTime":"2023-06-08 17:55:33","files":"","pos":"110.86844907087044,35.548506677274645","realName":"系统管理员"},{"id":72,"updateTime":"2023-06-08 17:57:14","profileId":1,"checkTime":"2023-06-08 17:55:33","files":"","pos":"110.86825959129743,35.548700049751275","realName":"系统管理员"}]`
        markersPosList = JSON.parse(str)
        markersPosList.map((item, i) => {
            const pos = {
                lng: item.pos.split(",")[0],
                lat: item.pos.split(",")[1]
            }
            let _marker = new vjmap.DiffusedApertureMarker({
                lngLat: pos
            }, {
                colors: ["red", "rgba(,0,0,0,0)"],
                textColor: "#000"
            }).createMarker();
            _marker.addTo(map)
            markers.push(_marker)
            _marker.on("click", (e) => {
                uni.postMessage({  
                    data: {  
                        action: {
                            type: 2,
                            data: item
                        }
                    }  
                });
                window.parent.postMessage({
                    params: {
                        type: 2,
                        data: item
                    }
                },'*');
            })
        })
    }
    // 删除点标记
    function removeMarker () {
        markers.map((item,i) => {
            item && item.remove()
        })
    }
    // 添加点击标记 如果已经有点击标记 则点击标记移动位置
    function setClickMarker (center) {
        if (!clickMarker) {
            clickMarker = new vjmap.Marker({color: "red"})
            clickMarker.setLngLat(center).addTo(map)
        } else {
            clickMarker.setLngLat(center)
        }
    }
    // 删除点击标记
    function clearClickMarker() {
        clickMarker.remove()
        clickMarker = null
    }
    // 显示当前人定位marker
    function showPeopleMarker () {
        if (!peopleMarker) {
            peopleMarker = new vjmap.Marker()
        }
        peopleMarker.setLngLat(center).addTo(map)
    }
    // 设置地图中心
    function setCenter(str) {
        center = str.split(",")
        peopleMarker.setLngLat(center)
        if (setCen) {
            map.setCenter(center)
        }
    }
    // 设置路径线
    function setLine(str) {
        // 路径线
        var routePath = JSON.parse(str)
        if (!routeLine) {
            routeLine = new vjmap.PolylineArrow({
                path: map.toLngLat(routePath),
                lineWidth: 10,
                showDir: true,
                lineColor: '#009EFF'
            })
            routeLine.addTo(map);
        } else {
            routeLine.setPath(map.toLngLat(routePath))
        }
    }
    // 恢复当前地图中心及缩放大小
    function mapResize() {
        map.easeTo({
            zoom: 18,
            center: center,
            bearing: 0,
            pitch: 0
        })
        setTimeout(() => {
            setCen = true
        }, 1000)
    }
    // uniapp加载地图
    function mapConfig (str) {
        const obj = JSON.parse(str)
        mapId = obj.mapId;
        accessToken = obj.accessToken;
        serviceUrl = obj.serviceUrl;
        // CAD图key
        accessKey = obj.accessKey
        loadMap()
        // loadOpenLayersMap()
    }

    // 接受VUE页面发来的信息
    window.addEventListener("message", function (event) {
        var params = event.data.params;
        // 定义一个变量去接收,然后就可以获得vue传过来的数据
        if (params) {
            var data = params["data"]
            if(params["type"] == 1) {
                if (data) {
                    mapId = data.mapId;
                    accessToken = data.accessToken;
                    serviceUrl = data.serviceUrl;
                    // CAD图key
                    accessKey = data.accessKey
                }
                loadMap()
                // loadOpenLayersMap()
            }
            if (params["type"] == 2) {
                trackPlayback(data, 2)
            }
            if (params["type"] == 3) {
                trackPlayback(data, 3)
            }
            if (params["type"] == 4) {
                trackPlayback(data, 4)
            }
            if (params["type"] == 5) {
                clearClickMarker()
            }
        }
    }, '*')
    // 轨迹回放
    function trackPlayback (data, type) {
        if (type == 2) {
            setLines(JSON.stringify(data))
        }
        if (type == 3) {
            removeMarker()
            setMarkerList(data)
        }
        if (type == 4) {
            fitBounds(data)
        }
        
        // if (anim) {
        //     anim.stop()
        // }
        // // 实时动画轨迹线
        // realRoute = new vjmap.PolylineArrow({
        //     path: map.toLngLat(routePath),
        //     lineWidth: 10,
        //     showDir: true,
        //     showBorder: true,
        //     borderColor: "#f00",
        //     lineColor: '#FF9900'
        // });
        // realRoute.addTo(map);
        // // 线动画
        // anim = realRoute.animate(100, 10, true, status => console.log(status), (status, context) => {
        //     // 动画每帧回调，在这里可以实时改变车的位置
        //     // 获取角度
        //     const angle = vjmap.geoPoint(context.endPnt).angleTo(vjmap.geoPoint(context.startPnt));
        //     // 生成新的数据
        //     const carGeoJson = vjmap.createPointGeoJson({
        //         point: context.endPnt,
        //         properties: { bearing: vjmap.radToDeg(-angle)}
        //     });
        //     const last = routePath[routePath.length - 1]
        //     // 判断点是否相等 
        //     if (vjmap.geoPoint(last).equals(vjmap.geoPoint(context.endPnt))) {
        //         anim.stop()
        //     }
        //     // 更新车的数据
        //     peopleMarker.setLngLat(context.endPnt); // 更新位置
        //     map.setCenter(context.endPnt)
        // })
    }
    // 设置多条路径线
    var routeLineList = []
    function setLines(str) {
        console.log("开始设置路线")
        if(peopleMarker) {
            peopleMarker.remove()
        }
        if (routeLineList.length) {
            routeLineList.map((item) => {
                item.remove()
            })
        }
        routeLineList = []
        // 路径线
        var list = JSON.parse(str)
        for(let i = 0; i < list.length; i++) {
            var routePath = list[i].path
            if (routePath.length) {
                routeLine = new vjmap.PolylineArrow({
                    path: map.toLngLat(routePath),
                    lineWidth: 10,
                    showDir: true,
                    lineColor: list[i].color
                })
                routeLine.addTo(map);
                routeLineList.push(routeLine)
            }
        }
        
    }
    // 平移和缩放地图以将其可见区域包含在指定的地理边界内
    function fitBounds(arr) {
        map.fitBounds(arr, {
            padding: {top: 30, bottom:30, left: 30, right: 30}
        })
    }
    


    document.addEventListener('UniAppJSBridgeReady', function() {
        uni.webView.getEnv(function(res) {
            console.log('当前环境：' + JSON.stringify(res));
        });
        // H5页面加载完毕
        uni.postMessage({  
            data: {  
                action: {
                    type: 1
                }
            }  
        });
        // 向父vue页面发送信息
        window.parent.postMessage({
            params: {
                type: 1
            }
        },'*');
    });
    function loadOpenLayersMap () {
        (async () => {
            let svc = new vjmap.Service(serviceUrl, accessToken)
            svc.addAccessKey(accessKey)
            
            let style = {
                backcolor: 0, // div为深色背景颜色时，这里也传深色背景样式
                clipbounds: Math.pow(2, 18) // 只传值，不传范围，表示之前的范围放大多少倍
            }
            let res = await svc.openMap({
                mapid: mapId,
                mapopenway: vjmap.MapOpenWay.GeomRender, // 以几何数据渲染方式打开
                style: vjmap.openMapDarkStyle() // div为深色背景颜色时，这里也传深色背景样式
            })
            if (res.error) {
                message.error(res.error)
            }
            // 获取地图的范围 res.bounds 为打开图后返回的图形范围
            let mapExtent = vjmap.GeoBounds.fromString(res.bounds);
            // 根据地图范围建立几何投影坐标系
            // let prj = new vjmap.GeoProjection(mapExtent);
            // 如果是图形坐标是经纬度，则根据地图范围建立经纬度投影坐标系
            let prj = new vjmap.LnglatProjection();

            const abc = proj4(formPro, toPro, center)
            console.log(vjmap.transform.getEpsgParam(vjmap.transform.EpsgCrsTypes.Beijing54, 39).epsg)
            console.log(center)
            let map = new vjmap.Map({
                container: 'map', // container ID
                style: svc.rasterStyle(),
                center: abc,
                zoom: 1,
                pitch: 0,
                pitchWithRotate: false, // 倾斜
                dragRotate: false, // 拖动旋转
                touchZoomRotate: true, // 捏合旋转和缩放
                doubleClickZoom: false, // 双击缩放
                renderWorldCopies: false // 不显示多屏地图
            });
            map.attach(svc, prj);
            map.setCenter(center)
            map.addControl(new vjmap.NavigationControl());
            map.addControl(new vjmap.MousePositionControl({showZoom: true}));

           
            console.log(res.bounds)
            map.on("click", (event) => {
                let point = map.fromLngLat(event.lngLat);
                console.log(`[${point.x},${point.y}]`)
            })

            // 增加高德地图底图
            const addGaodeMap = async (isRoadway) => {
                const tileUrl = svc.webMapUrl({
                    tileCrs: "gcj02",
                    tileUrl:  isRoadway ? [
                            "https://webrd0{s}.is.autonavi.com/appmaptile?lang=zh_cn&size=1&scale=1&style=8&x={x}&y={y}&z={z}"
                        ] :
                        /* 如果用影像 */
                        [
                            "https://webst0{s}.is.autonavi.com/appmaptile?lang=zh_cn&size=1&scale=1&style=6&x={x}&y={y}&z={z}",
                            "https://webst0{s}.is.autonavi.com/appmaptile?lang=zh_cn&size=1&scale=1&style=8&x={x}&y={y}&z={z}"
                        ],
                    tileSize: 256,
                    tileRetina: 1,
                    tileMaxZoom: 18,
                    tileShards: "1,2,3,4",
                    tileToken: "",
                    tileFlipY: false,
                    mapbounds: res.bounds,
                    srs: "EPSG:4546",// 可通过前两位获取 vjmap.transform.getEpsgParam(vjmap.transform.EpsgCrsTypes.CGCS2000, 39).epsg
                    // 因为sys_cad2000这个图只有6位，没有带系。需要在坐标转换前平移下带系  https://blog.csdn.net/thinkpang/article/details/124172626
                })

                map.addSource('web-gaode-source', {
                    'type': 'raster',
                    'tiles': [
                        tileUrl
                    ],
                    'tileSize': 256
                });
                map.addLayer({
                        'id': 'web-gaode-layer',
                        'type': 'raster',
                        'source': 'web-gaode-source',
                        'paint': { "raster-opacity": 1 }
                    }
                );
                let layers = map.getStyle().layers
                // 把这个图层放至所有图层的最下面
                map.moveLayer('web-gaode-layer', layers[0].id)

                // cad坐标与高德坐标相互转换示例
                // let webCo = await cad2webCoordinate(center, false); // cad转高德
                // let cadCo = await web2cadCoordinate(webCo, false); // 高德转cad
                // console.log(center, webCo, cadCo)
            }
            setTimeout(() => {
                addGaodeMap(true)
            }, 1000)
            

            let layers = svc.getMapLayers();
            // 通过图层名称来查找图层id
            const getLayerIdByName = name => {
                return svc.getMapLayers().findIndex(layer => layer.name === name)
            }

            // 增加实体图层判断条件,只要满足任何一种类型即可,如 ['图层一','图层二']
            const conditionLayers = (layers1, inputIsIndex) => {
                if (!Array.isArray(layers1)) layers1 = [layers1];// 先转成数组，再统一用数组去算吧
                if (!inputIsIndex) {
                    // 如果输入的不是图层索引，是图层名称，则需要转成图层索引
                    layers1 = layers1.map(layer => getLayerIdByName(layer)); // 把图层名称转为图层索引，在矢量瓦片中图层是用索引来表示的
                }
                return [
                    "match",
                    ['get', 'layer'],
                    layers1,
                    true,
                    false
                ]
            }
            // 切换图层 onLayers 要显示的图层名称数组
            const switchLayers = (onLayers) => {
               // 获取之前的默认的矢量图层样式，然后在当前样式中，对矢量图层的数据进行图层进行过滤
                let style = map.getStyle();
                let vectorStyle = svc.vectorStyle();
                let vectorLayerIds = vectorStyle.layers.map(layer => layer.id);
                let filter = conditionLayers(onLayers, false);
                for(let i = 0; i < style.layers.length; i++) {
                    if (vectorLayerIds.includes(style.layers[i].id)) {
                        style.layers[i].filter = filter; // 设置过滤条件
                    }
                }
                console.log(style)
                map.setStyle(style);
            }
            
            // let arr = []
            // console.log(layers)
            // layers.forEach((item) => {
            //     if (arr.length < 1) {
            //         arr.push(item.name)
            //     }
            // })
            // map.switchLayers(svc, arr)

            
            
        })();
    }
    function loadMap() {
        (async () => {
            // --高德地图与CAD图叠加[高德地图为底图]--高德地图与CAD图叠加，以高德地图为坐标系
             svc = new vjmap.Service(serviceUrl, accessToken)
            svc.addAccessKey(accessKey)
            // 根据地图范围建立经纬度投影坐标系
            let prj = new vjmap.LnglatProjection();
            
            // 地图对象
            map = new vjmap.Map({
                container: 'map', // DIV容器ID
                style: {
                    version: svc.styleVersion(),
                    glyphs: svc.glyphsUrl(),
                    sources: {
                        gaode: {
                            type: 'raster',
                            tiles: [
                                "https://webrd01.is.autonavi.com/appmaptile?lang=zh_cn&size=1&scale=1&style=8&x={x}&y={y}&z={z}"
                                // 影像地图
                                // "https://webst01.is.autonavi.com/appmaptile?lang=zh_cn&size=1&scale=1&style=6&x={x}&y={y}&z={z}"
                            ],
                        }
                    },
                    layers: [{
                        id: 'gaode',
                        type: 'raster',
                        source: 'gaode',
                    }]
                },
                center: center,
                zoom: 18,
                pitch: 0,
                pitchWithRotate: false, // 倾斜
                dragRotate: false, // 拖动旋转
                touchZoomRotate: true, // 捏合旋转和缩放
                doubleClickZoom: false, // 双击缩放
                renderWorldCopies: false // 不显示多屏地图
            });
            // 关联服务对象和投影对象
            map.attach(svc, prj);
            await map.onLoad();


            // 先打开cad图
            let res = await svc.openMap({
                mapid: mapId, // 地图ID
                mapopenway: vjmap.MapOpenWay.GeomRender, // 以几何数据渲染方式打开
                style: svc.vectorStyle()
            })
            if (res.error) {
                // 如果打开出错
                message.error(res.error)
            }
            let layer = res.layer;//图层样式名
            
            let cadEpsg = "EPSG:4546";// cad图的espg代号
            // 增加cad的wms图层
            let wmsUrl = svc.wmsTileUrl({
                mapid: mapId, // 地图id
                layers: layer, // 图层名称
                srs: "EPSG:3857",
                crs: cadEpsg,
                webMapType: "GCJ02" // 底图是高德地图，所以要选GCJ02,如果是天地图，可以不用填此项
            })

           
            map.addSource('wms-test-source', {
                'type': 'raster',
                'tiles': [
                    wmsUrl
                ],
                'tileSize': 256
            });
            map.addLayer({
                    'id': 'wms-test-layer',
                    'type': 'raster',
                    'source': 'wms-test-source',
                    'paint': { "raster-opacity": 1 }
                }
            );
            // 比例尺
            const scaleControl = new vjmap.ScaleControl();
            map.addControl(scaleControl, "bottom-left");
            // 导航条
            const navigationControl = new vjmap.NavigationControl();
            map.addControl(navigationControl, "top-right");
            // 地图加载完毕
            uni.postMessage({  
                data: {  
                    action: {
                        type: 1.1
                    }
                }  
            });
            // 向父vue页面发送信息
            window.parent.postMessage({
                params: {
                    type: 1.1
                }
            },'*');

            
            
            map.on("click", (event) => {
                let point = map.fromLngLat(event.lngLat);
                console.log(`[${point.x},${point.y}]`)
                // 向父vue页面发送信息
                // window.parent.postMessage({
                //     params: {
                //         type: 3,
                //         data: [point.x, point.y]
                //     }
                // },'*');
                var new_york = new vjmap.LngLat(point.x, point.y);
                var yuan = true
                markersPosList.map((item) => {
                    var pos = item.pos.split(",")
                    var los_angeles = new vjmap.LngLat(pos[0], pos[1]);
                    var juli = new_york.distanceTo(los_angeles);
                    if (juli < 10) {
                        yuan = false
                    }
                })
                if (yuan) {
                    uni.postMessage({  
                        data: {  
                            action: {
                                type: 3,
                                data: [point.x, point.y]
                            }
                        }  
                    });
                    // 点击位置添加标点
                    setClickMarker([point.x, point.y])
                }
                
            })
            map.on("move", () => {
                setCen = false
            })

            let layers = svc.getMapLayers();
            let arr = []
            layers.map((item) => {
                arr.push(item.name)
            })
            arr.length = 4
            console.log(arr)
            setTuCeng(arr)
            uni.postMessage({  
                data: {  
                    action: {
                        type: 4,
                        data: layers
                    }
                }  
            });

            
        })();
    }
    function setTuCeng (arr) {
        console.log(arr)
        console.log(typeof arr)
        if (typeof arr === "string") {
            arr = JSON.parse(arr)
        }
        (async () => {
            let cadEpsg = "EPSG:4546";// cad图的espg代号
            let res1 = await svc.cmdSwitchLayers(arr); // 调用唯杰服务切换图层，返回图层id {layerid： "xxxx"}
            map.removeLayer("wms-test-layer")
            map.removeSource('wms-test-source');
            wmsUrl = svc.wmsTileUrl({
                mapid: mapId, // 地图id
                layers: res1.id, // 图层名称
                srs: "EPSG:3857",
                crs: cadEpsg,
                webMapType: "GCJ02" // 底图是高德地图，所以要选GCJ02,如果是天地图，可以不用填此项
            })
            map.addSource('wms-test-source', {
                'type': 'raster',
                'tiles': [
                    wmsUrl
                ],
                'tileSize': 256
            });
            map.addLayer({
                    'id': 'wms-test-layer',
                    'type': 'raster',
                    'source': 'wms-test-source',
                    'paint': { "raster-opacity": 1 }
                }
            );
        })();
    }
    
    
    
    
    

   

    
</script>
</html>